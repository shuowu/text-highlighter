{"version":3,"file":"bundle.js","sources":["../src/dom/addClass.js","../src/dom/append.js","../src/dom/color.js","../src/dom/contains.js","../src/dom/fromHTML.js","../src/dom/getDocument.js","../src/dom/getWindow.js","../src/dom/getSelection.js","../src/dom/getRange.js","../src/dom/insertAfter.js","../src/dom/insertBefore.js","../src/constants.js","../src/dom/normalizeTextNodes.js","../src/dom/parents.js","../src/dom/prepend.js","../src/dom/remove.js","../src/dom/removeAllRanges.js","../src/dom/removeClass.js","../src/dom/unwrap.js","../src/dom/wrap.js","../src/utils/bindEvents.js","../src/utils/defaults.js","../src/utils/sortByDepth.js","../src/utils/isHighlight.js","../src/utils/haveSameColor.js","../src/utils/flattenNestedHighlights.js","../src/utils/groupHighlights.js","../src/utils/mergeSiblingHighlights.js","../src/utils/unique.js","../src/utils/normalizeHighlights.js","../src/utils/refineRangeBoundaries.js","../src/utils/unbindEvents.js","../src/TextHighlighter.js"],"sourcesContent":["/**\n * Adds class to element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @param {string} className\n */\n\nexport default function (el, className) {\n  if (el.classList) {\n    el.classList.add(className);\n  } else {\n    el.className += ` ${className}`;\n  }\n}\n","/**\n * Appends child nodes to base element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @param {Node[]} nodesToAppend\n */\nexport default function (el, nodesToAppend) {\n  const nodes = Array.prototype.slice.call(nodesToAppend);\n\n  for (let i = 0, len = nodes.length; i < len; ++i) {\n    el.appendChild(nodes[i]);\n  }\n}\n","/**\n * Returns element background color.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @returns {CSSStyleDeclaration.backgroundColor}\n */\nexport default function (el) {\n  return el.style.backgroundColor;\n}\n","/**\n * Returns true if base element contains given child.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @param {Node|HTMLElement} child\n * @returns {boolean}\n */\nexport default function (el, child) {\n  return el !== child && el.contains(child);\n}\n","/**\n * Creates dom element from given html string.\n * @param {string} html\n * @returns {NodeList}\n */\nexport default function (html) {\n  const div = document.createElement('div');\n  div.innerHTML = html;\n  return div.childNodes;\n}\n","/**\n * Returns document of the base element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @returns {HTMLDocument}\n */\nexport default function (el) {\n  // if ownerDocument is null then el is the document itself.\n  return el.ownerDocument || el;\n}\n","import getDocument from './getDocument';\n\n/**\n * Returns window of the base element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @returns {Window}\n */\nexport default function (el) {\n  return getDocument(el).defaultView;\n}\n","import getWindow from './getWindow';\n\n/**\n * Returns selection object of the window of base element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @returns {Selection}\n */\nexport default function (el) {\n  return getWindow(el).getSelection();\n}\n","import getSelection from './getSelection';\n\n/**\n * Returns first range of the window of base element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @returns {Range}\n */\nexport default function (el) {\n  const selection = getSelection(el);\n  let range;\n\n  if (selection.rangeCount > 0) {\n    range = selection.getRangeAt(0);\n  }\n\n  return range;\n}\n","/**\n * Inserts base element after refEl.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @param {Node} refEl - node after which base element will be inserted\n * @returns {Node} - inserted element\n */\nexport default function (el, refEl) {\n  return refEl.parentNode.insertBefore(el, refEl.nextSibling);\n}\n","/**\n * Inserts base element before refEl.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @param {Node} refEl - node before which base element will be inserted\n * @returns {Node} - inserted element\n */\nexport default function (el, refEl) {\n  return refEl.parentNode.insertBefore(el, refEl);\n}\n","export const NODE_TYPE = {\n  ELEMENT_NODE: 1,\n  TEXT_NODE: 3,\n};\n\n/**\n * Attribute added by default to every highlight.\n * @type {string}\n */\nexport const DATA_ATTR = 'data-highlighted';\n\n/**\n * Attribute used to group highlight wrappers.\n * @type {string}\n */\nexport const TIMESTAMP_ATTR = 'data-timestamp';\n\n\n/**\n * Don't highlight content of these tags.\n * @type {string[]}\n */\nexport const IGNORE_TAGS = [\n  'SCRIPT', 'STYLE', 'SELECT', 'OPTION', 'BUTTON', 'OBJECT', 'APPLET', 'VIDEO', 'AUDIO', 'CANVAS', 'EMBED',\n  'PARAM', 'METER', 'PROGRESS',\n];\n","import { NODE_TYPE } from '../constants';\n\nconst { TEXT_NODE } = NODE_TYPE;\n\n/**\n * Normalizes text nodes within base element, ie. merges sibling text nodes and assures that every\n * element node has only one text node.\n * It should does the same as standard element.normalize, but IE implements it incorrectly.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n */\nfunction normalizeTextNodes(el) {\n  if (!el) {\n    return;\n  }\n\n  if (el.nodeType === TEXT_NODE) {\n    while (el.nextSibling && el.nextSibling.nodeType === TEXT_NODE) {\n      el.nodeValue += el.nextSibling.nodeValue;\n      el.parentNode.removeChild(el.nextSibling);\n    }\n  } else {\n    normalizeTextNodes(el.firstChild);\n  }\n  normalizeTextNodes(el.nextSibling);\n}\n\nexport default normalizeTextNodes;\n","/**\n * Returns array of base element parents.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @returns {HTMLElement[]}\n */\nexport default function (el) {\n  let parent;\n  const path = [];\n\n  while (el.parentNode) {\n    parent = el.parentNode;\n    path.push(parent);\n    el = parent;\n  }\n\n  return path;\n}\n","/**\n * Prepends child nodes to base element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @param {Node[]} nodesToPrepend\n */\nexport default function (el, nodesToPrepend) {\n  const nodes = Array.prototype.slice.call(nodesToPrepend);\n  let i = nodes.length;\n\n  while (i--) {\n    el.insertBefore(nodes[i], el.firstChild);\n  }\n}\n","/**\n * Removes base element from DOM.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n */\nexport default function (el) {\n  el.parentNode.removeChild(el);\n  el = null;\n}\n","/**\n * Removes all ranges of the window of base element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n */\nexport default function (el) {\n  const selection = getSelection(el);\n  selection.removeAllRanges();\n}\n","/**\n * Removes class from element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @param {string} className\n */\nexport default function (el, className) {\n  if (el.classList) {\n    el.classList.remove(className);\n  } else {\n    el.className = el.className.replace(\n      new RegExp(`(^|\\\\b)${className}(\\\\b|$)`, 'gi'), ' ',\n    );\n  }\n}\n","import insertBefore from './insertBefore';\nimport remove from './remove';\n\n/**\n * Unwraps base element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @returns {Node[]} - child nodes of unwrapped element.\n */\nexport default function (el) {\n  const nodes = Array.prototype.slice.call(el.childNodes);\n  let wrapper;\n\n  nodes.forEach((node) => {\n    wrapper = node.parentNode;\n    insertBefore(wrapper, node.parentNode);\n    remove(wrapper);\n  });\n\n  return nodes;\n}\n","/**\n * Wraps base element in wrapper element.\n * @param {Node|HTMLElement} [el] - base DOM element to manipulate\n * @param {HTMLElement} wrapper\n * @returns {HTMLElement} wrapper element\n */\nexport default function (el, wrapper) {\n  if (el.parentNode) {\n    el.parentNode.insertBefore(wrapper, el);\n  }\n\n  wrapper.appendChild(el);\n  return wrapper;\n}\n","export default function bindEvents(el, scope) {\n  el.addEventListener('mouseup', scope.highlightHandler.bind(scope));\n  el.addEventListener('touchend', scope.highlightHandler.bind(scope));\n}\n","\n/**\n * Fills undefined values in obj with default properties with the same name from source object.\n * @param {object} obj - target object\n * @param {object} source - source object with default values\n * @returns {object}\n */\nexport default function defaults(obj, source) {\n  obj = obj || {};\n\n  Object.keys(source).forEach((prop) => {\n    obj[prop] = source[prop];\n  });\n\n  return obj;\n}\n","import { parents } from '../dom';\n\n/**\n * Sorts array of DOM elements by its depth in DOM tree.\n * @param {HTMLElement[]} arr - array to sort.\n * @param {boolean} descending - order of sort.\n */\nexport default function sortByDepth(arr, descending) {\n  arr.sort((a, b) => parents(descending ? b : a).length - parents(descending ? a : b).length);\n}\n","import { NODE_TYPE, DATA_ATTR } from '../constants';\n\n/**\n * Returns true if element is a highlight.\n * All highlights have 'data-highlighted' attribute.\n * @param el - element to check.\n * @returns {boolean}\n */\nexport default function isHighlight(el) {\n  return el && el.nodeType === NODE_TYPE.ELEMENT_NODE && el.hasAttribute(DATA_ATTR);\n}\n","import { color } from '../dom';\n\n/**\n * Returns true if elements a i b have the same color.\n * @param {Node} a\n * @param {Node} b\n * @returns {boolean}\n */\nexport default function haveSameColor(a, b) {\n  return color(a) === color(b);\n}\n","import sortByDepth from './sortByDepth';\nimport isHighlight from './isHighlight';\nimport haveSameColor from './haveSameColor';\nimport { remove, insertAfter, insertBefore } from '../dom';\n\n/**\n * Flattens highlights structure.\n * Note: this method changes input highlights -\n * their order and number after calling this method may change.\n * @param {Array} highlights - highlights to flatten.\n */\nexport default function (highlights) {\n  let again;\n\n  sortByDepth(highlights, true);\n\n  function flattenOnce() {\n    let shouldAgain = false;\n\n    highlights.forEach((hl, i) => {\n      const parent = hl.parentElement;\n      const parentPrev = parent.previousSibling;\n      const parentNext = parent.nextSibling;\n\n      if (isHighlight(parent)) {\n        if (!haveSameColor(parent, hl)) {\n          if (!hl.nextSibling) {\n            insertBefore(hl, parentNext || parent);\n            shouldAgain = true;\n          }\n\n          if (!hl.previousSibling) {\n            insertAfter(hl, parentPrev || parent);\n            shouldAgain = true;\n          }\n\n          if (!parent.hasChildNodes()) {\n            remove(parent);\n          }\n        } else {\n          parent.replaceChild(hl.firstChild, hl);\n          highlights[i] = parent;\n          shouldAgain = true;\n        }\n      }\n    });\n\n    return shouldAgain;\n  }\n\n  do {\n    again = flattenOnce();\n  } while (again);\n}\n","import { TIMESTAMP_ATTR } from '../constants';\n\n/**\n * Groups given highlights by timestamp.\n * @param {Array} highlights\n * @returns {Array} Grouped highlights.\n */\nexport default function groupHighlights(highlights) {\n  const order = [];\n  const chunks = {};\n  const grouped = [];\n\n  highlights.forEach((hl) => {\n    const timestamp = hl.getAttribute(TIMESTAMP_ATTR);\n\n    if (typeof chunks[timestamp] === 'undefined') {\n      chunks[timestamp] = [];\n      order.push(timestamp);\n    }\n\n    chunks[timestamp].push(hl);\n  });\n\n  order.forEach((timestamp) => {\n    const group = chunks[timestamp];\n\n    grouped.push({\n      chunks: group,\n      timestamp,\n      toString() {\n        return group.map((h) => h.textContent).join('');\n      },\n    });\n  });\n\n  return grouped;\n}\n","import haveSameColor from './haveSameColor';\nimport isHighlight from './isHighlight';\nimport {\n  prepend, append, remove, normalizeTextNodes,\n} from '../dom';\nimport { NODE_TYPE } from '../constants';\n\n\n/**\n * Merges sibling highlights and normalizes descendant text nodes.\n * Note: this method changes input highlights -\n * their order and number after calling this method may change.\n * @param highlights\n */\nexport default function (highlights) {\n  function shouldMerge(current, node) {\n    return node && node.nodeType === NODE_TYPE.ELEMENT_NODE\n          && haveSameColor(current, node)\n          && isHighlight(node);\n  }\n\n  highlights.forEach((highlight) => {\n    const prev = highlight.previousSibling;\n    const next = highlight.nextSibling;\n\n    if (shouldMerge(highlight, prev)) {\n      prepend(highlight, prev.childNodes);\n      remove(prev);\n    }\n    if (shouldMerge(highlight, next)) {\n      append(highlight, next.childNodes);\n      remove(next);\n    }\n\n    normalizeTextNodes(highlight);\n  });\n}\n","/**\n * Returns array without duplicated values.\n * @param {Array} arr\n * @returns {Array}\n */\nexport default function unique(arr) {\n  return arr.filter((value, idx, self) => self.indexOf(value) === idx);\n}\n","import flattenNestedHighlights from './flattenNestedHighlights';\nimport mergeSiblingHighlights from './mergeSiblingHighlights';\nimport unique from './unique';\n\n/**\n * Normalizes highlights. Ensures that highlighting is done with use of the smallest\n * possible number of wrapping HTML elements.\n * Flattens highlights structure and merges sibling highlights. Normalizes text nodes\n * within highlights.\n * @param {Array} highlights - highlights to normalize.\n * @returns {Array} - array of normalized highlights.\n *  Order and number of returned highlights may be different than input highlights.\n */\nexport default function (highlights) {\n  let normalizedHighlights;\n\n  flattenNestedHighlights(highlights);\n  mergeSiblingHighlights(highlights);\n\n  // omit removed nodes\n  normalizedHighlights = highlights.filter((hl) => (hl.parentElement ? hl : null));\n\n  normalizedHighlights = unique(normalizedHighlights);\n  normalizedHighlights.sort((a, b) => a.offsetTop - b.offsetTop || a.offsetLeft - b.offsetLeft);\n\n  return normalizedHighlights;\n}\n","import { NODE_TYPE } from '../constants';\n\nconst { TEXT_NODE } = NODE_TYPE;\n\n/**\n * Takes range object as parameter and refines it boundaries\n * @param range\n * @returns {object} refined boundaries and initial state of highlighting algorithm.\n */\nexport default function refineRangeBoundaries(range) {\n  let { startContainer } = range;\n  let { endContainer } = range;\n  const ancestor = range.commonAncestorContainer;\n  let goDeeper = true;\n\n  if (range.endOffset === 0) {\n    while (!endContainer.previousSibling && endContainer.parentNode !== ancestor) {\n      endContainer = endContainer.parentNode;\n    }\n    endContainer = endContainer.previousSibling;\n  } else if (endContainer.nodeType === TEXT_NODE) {\n    if (range.endOffset < endContainer.nodeValue.length) {\n      endContainer.splitText(range.endOffset);\n    }\n  } else if (range.endOffset > 0) {\n    endContainer = endContainer.childNodes.item(range.endOffset - 1);\n  }\n\n  if (startContainer.nodeType === TEXT_NODE) {\n    if (range.startOffset === startContainer.nodeValue.length) {\n      goDeeper = false;\n    } else if (range.startOffset > 0) {\n      startContainer = startContainer.splitText(range.startOffset);\n      if (endContainer === startContainer.previousSibling) {\n        endContainer = startContainer;\n      }\n    }\n  } else if (range.startOffset < startContainer.childNodes.length) {\n    startContainer = startContainer.childNodes.item(range.startOffset);\n  } else {\n    startContainer = startContainer.nextSibling;\n  }\n\n  return {\n    startContainer,\n    endContainer,\n    goDeeper,\n  };\n}\n","export default function unbindEvents(el, scope) {\n  el.removeEventListener('mouseup', scope.highlightHandler.bind(scope));\n  el.removeEventListener('touchend', scope.highlightHandler.bind(scope));\n}\n","import {\n  addClass,\n  removeClass,\n  getRange,\n  removeAllRanges,\n  contains,\n  wrap,\n  unwrap,\n  remove,\n  fromHTML,\n  getWindow,\n} from './dom';\nimport {\n  defaults,\n  bindEvents,\n  unbindEvents,\n  refineRangeBoundaries,\n  sortByDepth,\n  groupHighlights,\n  normalizeHighlights,\n} from './utils';\nimport {\n  TIMESTAMP_ATTR, NODE_TYPE, IGNORE_TAGS, DATA_ATTR,\n} from './constants';\n\nclass TextHighlighter {\n  /**\n   * Creates wrapper for highlights.\n   * TextHighlighter instance calls this method each time\n   * it needs to create highlights and pass options retrieved\n   * in constructor.\n   * @param {object} options - the same object as in TextHighlighter constructor.\n   * @returns {HTMLElement}\n   * @static\n   */\n  static createWrapper(options) {\n    const span = document.createElement('span');\n    span.style.backgroundColor = options.color;\n    span.className = options.highlightedClass;\n    return span;\n  }\n\n  /**\n   * Creates TextHighlighter instance and binds to given DOM elements.\n   * @param {HTMLElement} element - DOM element to which highlighted will be applied.\n   * @param {object} [options] - additional options.\n   * @param {string} options.color - highlight color.\n   * @param {string} options.highlightedClass - class added to highlight, 'highlighted' by default.\n   * @param {string} options.contextClass - class added to element to which highlighter is applied,\n   *  'highlighter-context' by default.\n   * @param {function} options.onRemoveHighlight - function called before highlight is removed.\n   *  Highlight is passed as param. Function should return true if highlight should be removed,\n   *  or false - to prevent removal.\n   * @param {function} options.onBeforeHighlight - function called before highlight is created.\n   *  Range object is passed as param. Function should return true to continue processing,\n   *  or false - to prevent highlighting.\n   * @param {function} options.onAfterHighlight - function called after highlight is created.\n   *  Array of created wrappers is passed as param.\n   */\n  constructor(element, options) {\n    if (!element) {\n      throw new Error('Missing anchor element');\n    }\n\n    this.el = element;\n    this.options = defaults(options, {\n      color: '#ffff7b',\n      highlightedClass: 'highlighted',\n      contextClass: 'highlighter-context',\n      onRemoveHighlight() { return true; },\n      onBeforeHighlight() { return true; },\n      onAfterHighlight() { },\n    });\n\n    addClass(this.el, this.options.contextClass);\n    bindEvents(this.el, this);\n  }\n\n  /**\n   * Permanently disables highlighting.\n   * Unbinds events and remove context element class.\n   */\n  destroy() {\n    unbindEvents(this.el, this);\n    removeClass(this.el, this.options.contextClass);\n  }\n\n  highlightHandler() {\n    this.doHighlight();\n  }\n\n  /**\n   * Highlights current range.\n   * @param {boolean} keepRange - Don't remove range after highlighting. Default: false.\n   */\n  doHighlight(keepRange) {\n    const range = getRange(this.el);\n    let wrapper;\n    let createdHighlights;\n    let normalizedHighlights;\n    let timestamp;\n\n    if (!range || range.collapsed) {\n      return;\n    }\n\n    if (this.options.onBeforeHighlight(range) === true) {\n      timestamp = +new Date();\n      wrapper = TextHighlighter.createWrapper(this.options);\n      wrapper.setAttribute(TIMESTAMP_ATTR, timestamp);\n\n      createdHighlights = this.highlightRange(range, wrapper);\n      normalizedHighlights = normalizeHighlights(createdHighlights);\n\n      this.options.onAfterHighlight(range, normalizedHighlights, timestamp);\n    }\n\n    if (!keepRange) {\n      removeAllRanges(this.el);\n    }\n  }\n\n  /**\n   * Highlights range.\n   * Wraps text of given range object in wrapper element.\n   * @param {Range} range\n   * @param {HTMLElement} wrapper\n   * @returns {Array} - array of created highlights.\n   */\n  highlightRange(range, wrapper) {\n    if (!range || range.collapsed) {\n      return [];\n    }\n\n    const result = refineRangeBoundaries(range);\n    const { startContainer } = result;\n    const { endContainer } = result;\n    let { goDeeper } = result;\n    let done = false;\n    let node = startContainer;\n    const highlights = [];\n    let highlight;\n    let wrapperClone;\n    let nodeParent;\n\n    do {\n      if (goDeeper && node.nodeType === NODE_TYPE.TEXT_NODE) {\n        if (IGNORE_TAGS.indexOf(node.parentNode.tagName) === -1 && node.nodeValue.trim() !== '') {\n          wrapperClone = wrapper.cloneNode(true);\n          wrapperClone.setAttribute(DATA_ATTR, true);\n          nodeParent = node.parentNode;\n\n          // highlight if a node is inside the el\n          if (contains(this.el, nodeParent) || nodeParent === this.el) {\n            highlight = wrap(node, wrapperClone);\n            highlights.push(highlight);\n          }\n        }\n\n        goDeeper = false;\n      }\n      if (node === endContainer && !(endContainer.hasChildNodes() && goDeeper)) {\n        done = true;\n      }\n\n      if (node.tagName && IGNORE_TAGS.indexOf(node.tagName) > -1) {\n        if (endContainer.parentNode === node) {\n          done = true;\n        }\n        goDeeper = false;\n      }\n      if (goDeeper && node.hasChildNodes()) {\n        node = node.firstChild;\n      } else if (node.nextSibling) {\n        node = node.nextSibling;\n        goDeeper = true;\n      } else {\n        node = node.parentNode;\n        goDeeper = false;\n      }\n    } while (!done);\n\n    return highlights;\n  }\n\n  /**\n   * Sets highlighting color.\n   * @param {string} color - valid CSS color.\n   */\n  setColor(color) {\n    this.options.color = color;\n  }\n\n  /**\n   * Returns highlighting color.\n   * @returns {string}\n   */\n  getColor() {\n    return this.options.color;\n  }\n\n\n  /**\n   * Removes highlights from element. If element is a highlight itself, it is removed as well.\n   * If no element is given, all highlights all removed.\n   * @param {HTMLElement} [element] - element to remove highlights from\n   */\n  removeHighlights(element) {\n    const container = element || this.el;\n    const highlights = this.getHighlights({ container });\n    const self = this;\n\n    function mergeSiblingTextNodes(textNode) {\n      const prev = textNode.previousSibling;\n      const next = textNode.nextSibling;\n\n      if (prev && prev.nodeType === NODE_TYPE.TEXT_NODE) {\n        textNode.nodeValue = prev.nodeValue + textNode.nodeValue;\n        remove(prev);\n      }\n      if (next && next.nodeType === NODE_TYPE.TEXT_NODE) {\n        textNode.nodeValue += next.nodeValue;\n        remove(next);\n      }\n    }\n\n    function removeHighlight(highlight) {\n      const textNodes = unwrap(highlight);\n\n      textNodes.forEach((node) => {\n        mergeSiblingTextNodes(node);\n      });\n    }\n\n    sortByDepth(highlights, true);\n\n    highlights.forEach((hl) => {\n      if (self.options.onRemoveHighlight(hl) === true) {\n        removeHighlight(hl);\n      }\n    });\n  }\n\n  /**\n   * Returns highlights from given container.\n   * @param params\n   * @param {HTMLElement} [params.container] - return highlights from this element.\n   * Default: the element the highlighter is applied to.\n   * @param {boolean} [params.andSelf] - if set to true and container is a highlight itself,\n   * add container to returned results. Default: true.\n   * @param {boolean} [params.grouped] - if set to true,\n   * highlights are grouped in logical groups of highlights added in the same moment.\n   * Each group is an object which has got array of highlights, 'toString' method and 'timestamp'\n   * property. Default: false.\n   * @returns {Array} - array of highlights.\n   */\n  getHighlights(params) {\n    params = defaults(params, {\n      container: this.el,\n      andSelf: true,\n      grouped: false,\n    });\n\n    const nodeList = params.container.querySelectorAll(`[${DATA_ATTR}]`);\n    let highlights = Array.prototype.slice.call(nodeList);\n\n    if (params.andSelf === true && params.container.hasAttribute(DATA_ATTR)) {\n      highlights.push(params.container);\n    }\n\n    if (params.grouped) {\n      highlights = groupHighlights(highlights);\n    }\n\n    return highlights;\n  }\n\n  /**\n   * Serializes all highlights in the element the highlighter is applied to.\n   * @returns {string} - stringified JSON with highlights definition\n   */\n  serializeHighlights() {\n    const highlights = this.getHighlights();\n    const refEl = this.el;\n    const hlDescriptors = [];\n\n    function getElementPath(el, refElement) {\n      const path = [];\n      let childNodes;\n\n      do {\n        childNodes = Array.prototype.slice.call(el.parentNode.childNodes);\n        path.unshift(childNodes.indexOf(el));\n        el = el.parentNode;\n      } while (el !== refElement || !el);\n\n      return path;\n    }\n\n    sortByDepth(highlights, false);\n\n    highlights.forEach((highlight) => {\n      let offset = 0; // Hl offset from previous sibling within parent node.\n      const { length } = highlight.textContent;\n      const hlPath = getElementPath(highlight, refEl);\n      let wrapper = highlight.cloneNode(true);\n\n      wrapper.innerHTML = '';\n      wrapper = wrapper.outerHTML;\n\n      if (highlight.previousSibling && highlight.previousSibling.nodeType === NODE_TYPE.TEXT_NODE) {\n        offset = highlight.previousSibling.length;\n      }\n\n      hlDescriptors.push([\n        wrapper,\n        highlight.textContent,\n        hlPath.join(':'),\n        offset,\n        length,\n      ]);\n    });\n\n    return JSON.stringify(hlDescriptors);\n  }\n\n  /**\n   * Deserializes highlights.\n   * @throws exception when can't parse JSON or JSON has invalid structure.\n   * @param {object} json - JSON object with highlights definition.\n   * @returns {Array} - array of deserialized highlights.\n   */\n  deserializeHighlights(json) {\n    let hlDescriptors;\n    const highlights = [];\n    const self = this;\n\n    if (!json) {\n      return highlights;\n    }\n\n    try {\n      hlDescriptors = JSON.parse(json);\n    } catch (e) {\n      throw new Error(`Can't parse JSON: ${e}`);\n    }\n\n    function deserializationFn(hlDescriptor) {\n      const hl = {\n        wrapper: hlDescriptor[0],\n        text: hlDescriptor[1],\n        path: hlDescriptor[2].split(':'),\n        offset: hlDescriptor[3],\n        length: hlDescriptor[4],\n      };\n      let elIndex = hl.path.pop();\n      let node = self.el;\n      let idx;\n\n      // eslint-disable-next-line no-cond-assign\n      while (idx = hl.path.shift()) {\n        node = node.childNodes[idx];\n      }\n\n      if (node.childNodes[elIndex - 1]\n          && node.childNodes[elIndex - 1].nodeType === NODE_TYPE.TEXT_NODE) {\n        elIndex -= 1;\n      }\n\n      node = node.childNodes[elIndex];\n      const hlNode = node.splitText(hl.offset);\n      hlNode.splitText(hl.length);\n\n      if (hlNode.nextSibling && !hlNode.nextSibling.nodeValue) {\n        remove(hlNode.nextSibling);\n      }\n\n      if (hlNode.previousSibling && !hlNode.previousSibling.nodeValue) {\n        remove(hlNode.previousSibling);\n      }\n\n      const highlight = wrap(hlNode, fromHTML(hl.wrapper)[0]);\n      highlights.push(highlight);\n    }\n\n    hlDescriptors.forEach((hlDescriptor) => {\n      try {\n        deserializationFn(hlDescriptor);\n      } catch (e) {\n        if (console && console.warn) {\n          console.warn(`Can't deserialize highlight descriptor. Cause: ${e}`);\n        }\n      }\n    });\n\n    return highlights;\n  }\n\n  /**\n   * Finds and highlights given text.\n   * @param {string} text - text to search for\n   * @param {boolean} [caseSensitive] - if set to true,\n   *  performs case sensitive search (default: true)\n   */\n  find(text, caseSensitive) {\n    const wnd = getWindow(this.el);\n    const { scrollX } = wnd;\n    const { scrollY } = wnd;\n    const caseSens = (typeof caseSensitive === 'undefined' ? true : caseSensitive);\n\n    removeAllRanges(this.el);\n\n    if (wnd.find) {\n      while (wnd.find(text, caseSens)) {\n        this.doHighlight(true);\n      }\n    } else if (wnd.document.body.createTextRange) {\n      const textRange = wnd.document.body.createTextRange();\n      textRange.moveToElementText(this.el);\n      while (textRange.findText(text, 1, caseSens ? 4 : 0)) {\n        if (!contains(this.el, textRange.parentElement())\n            && textRange.parentElement() !== this.el) {\n          break;\n        }\n\n        textRange.select();\n        this.doHighlight(true);\n        textRange.collapse(false);\n      }\n    }\n\n    removeAllRanges(this.el);\n    wnd.scrollTo(scrollX, scrollY);\n  }\n}\n\nexport default TextHighlighter;\n"],"names":["el","className","classList","add","nodesToAppend","nodes","Array","prototype","slice","call","i","len","length","appendChild","style","backgroundColor","child","contains","html","div","document","createElement","innerHTML","childNodes","ownerDocument","getDocument","defaultView","getWindow","getSelection","selection","range","rangeCount","getRangeAt","refEl","parentNode","insertBefore","nextSibling","NODE_TYPE","ELEMENT_NODE","TEXT_NODE","DATA_ATTR","TIMESTAMP_ATTR","IGNORE_TAGS","normalizeTextNodes","nodeType","nodeValue","removeChild","firstChild","parent","path","push","nodesToPrepend","removeAllRanges","remove","replace","RegExp","wrapper","forEach","node","bindEvents","scope","addEventListener","highlightHandler","bind","defaults","obj","source","Object","keys","prop","sortByDepth","arr","descending","sort","a","b","parents","isHighlight","hasAttribute","haveSameColor","color","highlights","again","flattenOnce","shouldAgain","hl","parentElement","parentPrev","previousSibling","parentNext","insertAfter","hasChildNodes","replaceChild","groupHighlights","order","chunks","grouped","timestamp","getAttribute","group","toString","map","h","textContent","join","shouldMerge","current","highlight","prev","next","prepend","append","unique","filter","value","idx","self","indexOf","normalizedHighlights","flattenNestedHighlights","mergeSiblingHighlights","offsetTop","offsetLeft","refineRangeBoundaries","startContainer","endContainer","ancestor","commonAncestorContainer","goDeeper","endOffset","splitText","item","startOffset","unbindEvents","removeEventListener","TextHighlighter","options","span","highlightedClass","element","Error","contextClass","onRemoveHighlight","onBeforeHighlight","onAfterHighlight","addClass","removeClass","doHighlight","keepRange","getRange","createdHighlights","collapsed","Date","createWrapper","setAttribute","highlightRange","normalizeHighlights","result","done","wrapperClone","nodeParent","tagName","trim","cloneNode","wrap","container","getHighlights","mergeSiblingTextNodes","textNode","removeHighlight","textNodes","unwrap","params","andSelf","nodeList","querySelectorAll","hlDescriptors","getElementPath","refElement","unshift","offset","hlPath","outerHTML","JSON","stringify","json","parse","e","deserializationFn","hlDescriptor","text","split","elIndex","pop","shift","hlNode","fromHTML","console","warn","caseSensitive","wnd","scrollX","scrollY","caseSens","find","body","createTextRange","textRange","moveToElementText","findText","select","collapse","scrollTo"],"mappings":"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"}